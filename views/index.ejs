<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabSystem Pro | Gestión Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main: #1e293b; --accent: #2563eb; --success: #059669; --danger: #dc2626; --warning: #d97706; --bg: #f1f5f9; }
        body { display: flex; font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: #334155; min-height: 100vh; }
        
        /* Sidebar - Ajustado para no pisar el contenido */
        nav { width: 280px; background: var(--main); color: white; height: 100vh; padding: 25px; position: fixed; left: 0; top: 0; z-index: 1000; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        nav h2 { color: #60a5fa; font-size: 1.3rem; text-align: center; border-bottom: 1px solid #334155; padding-bottom: 20px; margin-bottom: 20px; }
        nav ul { list-style: none; padding: 0; margin: 0; }
        nav li { padding: 14px 18px; cursor: pointer; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        nav li:hover { background: #334155; transform: translateX(5px); }
        nav li.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* Contenido Principal - Margen corregido para dar aire al sidebar */
        main { margin-left: 280px; padding: 40px; width: calc(100% - 280px); box-sizing: border-box; }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; }
        #page-title { font-size: 1.8rem; font-weight: 700; color: var(--main); margin: 0; }

        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 25px; }
        
        /* Botones */
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-new { background: var(--success); color: white; }
        .btn-refresh { background: #64748b; color: white; }
        .btn-save { background: var(--accent); color: white; }
        .btn-cancel { background: #94a3b8; color: white; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* Formulario Dinámico */
        #form-section { display: none; background: #f8fafc; border: 2px dashed #cbd5e1; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
        input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* Tabla */
        .table-wrapper { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #475569; }
        tr:hover { background: #fdfdfd; }
        
        .actions-cell { display: flex; gap: 12px; }
        .action-btn { border: none; background: none; cursor: pointer; font-size: 18px; transition: 0.2s; padding: 5px; }
        .edit-icon { color: var(--warning); }
        .delete-icon { color: var(--danger); }
        .action-btn:hover { transform: scale(1.2); }
    </style>
</head>
<body>

    <nav>
        <h2><i class="fas fa-microscope"></i> LAB-PRO v2</h2>
        <ul>
            <li id="li-pacientes" class="active" onclick="switchModulo('pacientes')"><i class="fas fa-hospital-user"></i> Pacientes</li>
            <li id="li-medicos" onclick="switchModulo('medicos')"><i class="fas fa-user-md"></i> Médicos</li>
            <li id="li-examenes" onclick="switchModulo('examenes')"><i class="fas fa-vials"></i> Exámenes</li>
            <li id="li-resultados" onclick="switchModulo('resultados')"><i class="fas fa-clipboard-check"></i> Resultados</li>
            <li id="li-usuarios" onclick="switchModulo('usuarios')"><i class="fas fa-user-shield"></i> Usuarios</li>
        </ul>
    </nav>

    <main>
        <div class="header-flex">
            <h1 id="page-title">Gestión de Pacientes</h1>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-new" onclick="abrirFormulario()"><i class="fas fa-plus-circle"></i> Nuevo Registro</button>
                <button class="btn btn-refresh" onclick="cargarDatos()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        <div id="form-section" class="card">
            <h3 id="form-title" style="margin-top: 0; margin-bottom: 20px; color: var(--main);">Nuevo Registro</h3>
            <form id="crud-form">
                <div id="dynamic-inputs" class="grid-inputs">
                    </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                    <button type="button" class="btn btn-cancel" onclick="cerrarFormulario()">Descartar</button>
                    <button type="submit" class="btn btn-save"><i class="fas fa-check-circle"></i> Guardar Registro</button>
                </div>
            </form>
        </div>

        <div class="card table-wrapper">
            <table>
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </main>

    <script>
        let modActual = 'pacientes';
        let editId = null;

        const esquemas = {
            pacientes: {
                labels: ['Nombre', 'Cédula', 'Teléfono'],
                keys: ['nombre', 'ci', 'telefono'],
                inputs: [{n:'nombre', l:'Nombre Completo', t:'text'}, {n:'ci', l:'Cédula', t:'text'}, {n:'telefono', l:'Teléfono', t:'text'}]
            },
            medicos: {
                labels: ['Médico', 'Especialidad', 'MPPS'],
                keys: ['nombre', 'especialidad', 'mpps'],
                inputs: [{n:'nombre', l:'Nombre del Médico', t:'text'}, {n:'especialidad', l:'Especialidad', t:'text'}, {n:'mpps', l:'Registro MPPS', t:'text'}]
            },
            examenes: {
                labels: ['Orden', 'Examen', 'Precio'],
                keys: ['numeroOrden', 'nombre', 'precio'],
                inputs: [{n:'numeroOrden', l:'N° Orden', t:'text'}, {n:'nombre', l:'Nombre del Examen', t:'text'}, {n:'precio', l:'Precio ($)', t:'number'}, {n:'medicoId', l:'ID Médico (Relación)', t:'text'}]
            },
            usuarios: {
                labels: ['Usuario', 'Rol', 'Cargo'],
                keys: ['username', 'rol', 'cargo'],
                inputs: [{n:'username', l:'Username', t:'text'}, {n:'rol', l:'Rol de Sistema', t:'select', o:['Admin','Bioanalista','Recepcion']}, {n:'cargo', l:'Cargo Laboral', t:'text'}]
            },
            resultados: {
                labels: ['Orden', 'Valor', 'Paciente'],
                keys: ['numeroOrden', 'valor', 'pacienteId'],
                inputs: [{n:'numeroOrden', l:'N° Orden', t:'text'}, {n:'valor', l:'Valor del Resultado', t:'text'}, {n:'pacienteId', l:'ID Paciente', t:'text'}, {n:'medicoId', l:'ID Médico', t:'text'}]
            }
        };

        function switchModulo(m) {
            modActual = m;
            document.querySelectorAll('nav li').forEach(l => l.classList.remove('active'));
            document.getElementById(`li-${m}`).classList.add('active');
            document.getElementById('page-title').innerText = `Gestión de ${m.charAt(0).toUpperCase() + m.slice(1)}`;
            cerrarFormulario();
            cargarDatos();
        }

        function abrirFormulario(data = null) {
            editId = data ? data._id : null;
            const container = document.getElementById('dynamic-inputs');
            document.getElementById('form-title').innerText = editId ? 'Modificar Información' : 'Registrar Nuevo ' + modActual.slice(0,-1);
            
            container.innerHTML = esquemas[modActual].inputs.map(i => {
                if(i.t === 'select') {
                    return `<div class="input-group"><label>${i.l}</label><select id="in-${i.n}">${i.o.map(opt=>`<option value="${opt}" ${data&&data[i.n]==opt?'selected':''}>${opt}</option>`).join('')}</select></div>`;
                }
                return `<div class="input-group"><label>${i.l}</label><input type="${i.t}" id="in-${i.n}" value="${data ? (data[i.n]||'') : ''}" required placeholder="Ingrese ${i.l}..."></div>`;
            }).join('');

            document.getElementById('form-section').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cerrarFormulario() {
            document.getElementById('form-section').style.display = 'none';
            document.getElementById('crud-form').reset();
            editId = null;
        }

        async function cargarDatos() {
            const config = esquemas[modActual];
            document.getElementById('thead').innerHTML = `<tr>${config.labels.map(l=>`<th>${l}</th>`).join('')}<th>Acciones</th></tr>`;
            
            const res = await fetch(`/api/${modActual}`);
            const data = await res.json();

            document.getElementById('tbody').innerHTML = data.map(item => `
                <tr>
                    ${config.keys.map(k => {
                        let val = item[k];
                        if(val && typeof val === 'object') val = val.nombre || val.username || val._id;
                        return `<td>${val || '-'}</td>`;
                    }).join('')}
                    <td class="actions-cell">
                        <button class="action-btn edit-icon" title="Editar" onclick='abrirFormulario(${JSON.stringify(item)})'><i class="fas fa-pen-to-square"></i></button>
                        <button class="action-btn delete-icon" title="Eliminar" onclick="eliminar('${item._id}')"><i class="fas fa-trash-can"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('crud-form').onsubmit = async (e) => {
            e.preventDefault();
            const body = {};
            esquemas[modActual].inputs.forEach(i => body[i.n] = document.getElementById(`in-${i.n}`).value);

            const method = editId ? 'PUT' : 'POST';
            const url = editId ? `/api/${modActual}/${editId}` : `/api/${modActual}`;

            try {
                const res = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if(res.ok) { cerrarFormulario(); cargarDatos(); }
            } catch (err) { alert("Error al procesar la solicitud"); }
        };

        async function eliminar(id) {
            if(confirm('¿Está seguro de eliminar este registro permanentemente?')) {
                await fetch(`/api/${modActual}/${id}`, { method: 'DELETE' });
                cargarDatos();
            }
        }

        window.onload = cargarDatos;
    </script>
</body>
</html>